class e{constructor(e,t){this.deck=[],this.selectedCards=[],this.maxScore=e,this.score=0,this.startTime=0,this.elapsed=0,this.duration=1e3*t;for(let t=1;t<=e;t++)this.deck.push(t);this.deck=this.deck.concat(...this.deck)}bindTurnResolved(e){this.onTurnResolved=e}bindVictory(e){this.onVictory=e}bindTimeUpdate(e){this.onTimeUpdate=e}bindTimeout(e){this.onTimeout=e}init(){this.shuffle(),this.score=0,this.startTime=(new Date).getTime(),this.elapsed=0,this.timerInterval=setInterval((()=>{this.updateTimer()}),10)}updateTimer(){const e=(new Date).getTime();this.elapsed=e-this.startTime,this.elapsed>this.duration?(clearInterval(this.timerInterval),this.onTimeout()):this.onTimeUpdate(this.elapsed,this.duration)}shuffle(){this.deck.sort((()=>Math.random()-.5))}getDeck(){return[...this.deck]}selectCard(e){this.selectedCards.push(e),2===this.selectedCards.length&&this.resolveTurn()}resolveTurn(){this.deck[this.selectedCards[0]]==this.deck[this.selectedCards[1]]?(this.score+=1,this.onTurnResolved({match:!0,cards:this.selectedCards}),this.checkVictory()):this.onTurnResolved({match:!1,cards:this.selectedCards}),this.selectedCards=[]}checkVictory(){this.score==this.maxScore&&(clearInterval(this.timerInterval),(async e=>{fetch("/scores",{method:"POST",body:JSON.stringify({score:e}),headers:new Headers({"Content-Type":"application/json"})}).catch((e=>{console.error(e)}))})(parseInt(this.elapsed/1e3)),this.onVictory(this.elapsed))}async getHighScores(){return await(async()=>fetch("/scores",{method:"GET"}).then((e=>e.json())).then((e=>e.map((e=>e.score)))).catch((e=>{console.error(e)})))()}}class t{constructor(e,t){this.callback=t;const s=document.createElement("div"),i=document.createElement("div"),a=document.createElement("div");s.classList.add("popup"),i.classList.add("content"),a.classList.add("close-btn"),a.textContent="Fermer",i.appendChild(e),s.appendChild(i),s.appendChild(a),a.addEventListener("click",(e=>this.close(e))),document.body.appendChild(s)}close(e){e.target.parentElement.remove(),this.callback&&(this.callback(),this.callback=null)}}class s{constructor(e){this.element=e,this.CardsContainer=document.createElement("div"),this.CardsContainer.classList.add("board"),this.element.appendChild(this.CardsContainer),this.progressBar=document.createElement("div"),this.progressBar.classList.add("progress");const t=document.createElement("div");t.classList.add("timer-container"),t.appendChild(this.progressBar),this.element.appendChild(t)}bindGetHighScores(e){this.getHighScores=e}bindSelectCard(e){this.selectCard=e}bindRestartGame(e){this.restartGame=e}init(e){this.playedCards=[],this.initCards(e),this.CardsContainer.onclick=e=>this.onCardClick(e)}initCards(e){this.element.querySelectorAll(".card").forEach((e=>e.remove())),e.forEach((e=>{const t=this.buildCard(e);this.CardsContainer.appendChild(t)}))}buildCard(e){const t=document.createElement("div"),s=document.createElement("div"),i=document.createElement("div"),a=document.createElement("div");return t.classList.add("card"),s.classList.add("card-faces-container"),i.classList.add("card-face-front",`card-face-${e}`),a.classList.add("card-face-back"),s.appendChild(i),s.appendChild(a),t.append(s),t}async buildHighscores(){const e=await this.getHighScores(),t=document.createElement("ul");return t.classList.add("highscores"),e.forEach(((e,s)=>{const i=document.createElement("li");i.innerHTML=`<strong>${s+1}</strong> ${e}`,t.appendChild(i)})),t}onCardClick(e){const t=e.target;t.classList.contains("is-flipped")||t.classList.contains("is-matched")||!t.classList.contains("card")||(t.classList.add("is-flipped"),this.selectCard(this.getCardIndex(t)))}onTimeUpdate(e,t){this.progressBar.style.width=e/t*100+"%"}onTurnResolved(e){setTimeout((()=>{const t=this.getCardByIndex(e.cards[0]),s=this.getCardByIndex(e.cards[1]);e.match&&(t.classList.add("is-matched"),s.classList.add("is-matched")),t.classList.remove("is-flipped"),s.classList.remove("is-flipped")}),500)}onVictory(e){setTimeout((async()=>{const s=document.createElement("div"),i=await this.buildHighscores();s.innerHTML=`<p>Vous avez gagn√© en <br>${parseInt(e/1e3)} secondes</p>`,s.appendChild(i),new t(s,this.restartGame)}),500)}onTimeout(){this.element.querySelector(".progress").style.width="100%",this.CardsContainer.onclick=null;const e=document.createElement("p");e.innerHTML="vous avez perdu",new t(e,this.restartGame)}getCardByIndex(e){return this.CardsContainer.querySelectorAll(".card")[e]}getCardIndex(e){return[...this.CardsContainer.querySelectorAll(".card")].indexOf(e)}}class i{constructor(e,t){this.model=e,this.view=t,this.model.bindTurnResolved((e=>this.onTurnResolved(e))),this.model.bindVictory((e=>this.onVictory(e))),this.model.bindTimeout((()=>this.onTimeout())),this.model.bindTimeUpdate(((e,t)=>this.onTimeUpdate(e,t))),this.view.bindSelectCard((e=>this.selectCard(e))),this.view.bindRestartGame((()=>this.start())),this.view.bindGetHighScores((()=>this.getHighscores()))}onTurnResolved(e){this.view.onTurnResolved(e)}onVictory(e){this.view.onVictory(e)}onTimeout(){this.view.onTimeout()}onTimeUpdate(e,t){this.view.onTimeUpdate(e,t)}selectCard(e){this.model.selectCard(e)}getDeck(){return this.model.getDeck()}getHighscores(){return this.model.getHighScores()}start(){this.model.init(),this.view.init(this.model.getDeck())}}new class{constructor(t,a,r){this.app=new i(new e(t,a),new s(r)),this.app.start()}}(14,120,document.querySelector("#app"));
